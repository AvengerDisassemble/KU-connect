# Migration Guide: Int IDs ‚Üí String cuid() IDs

## üìã Overview
This guide documents the complete migration from integer autoincrement IDs to string cuid() IDs across the entire KU Connect backend.

## ‚ö†Ô∏è IMPORTANT: Database Migration Steps

### 1. Backup Your Database
```bash
# For SQLite (dev/test)
cp prisma/dev.db prisma/dev.db.backup
cp prisma/test.db prisma/test.db.backup

# For PostgreSQL (production)
pg_dump ku_connect > backup_$(date +%Y%m%d).sql
```

### 2. Format and Validate Schema
```bash
npx prisma format
npx prisma validate
```

### 3. Create Migration
```bash
npx prisma migrate dev --name id_to_string_conversion
```

### 4. Generate Prisma Client
```bash
npx prisma generate
```

### 5. Run Seed (Fresh Database)
```bash
npx prisma migrate reset --skip-seed
npm run seed
# OR
node prisma/seed.js
```

### 6. Test the Migration
```bash
npm test
```

## üìù Changes Made

### Prisma Schema (`prisma/schema.prisma`)
**All models updated:**
- `Professor.id`: `Int` ‚Üí `String @default(cuid())`
- `Admin.id`: `Int` ‚Üí `String @default(cuid())`
- `Student.id`: `Int` ‚Üí `String @default(cuid())`
- `HR.id`: `Int` ‚Üí `String @default(cuid())`
- `DegreeType.id`: `Int` ‚Üí `String @default(cuid())`
- `Job.id`: `Int` ‚Üí `String @default(cuid())`
- `Tag.id`: `Int` ‚Üí `String @default(cuid())`
- `Requirement.id`: `Int` ‚Üí `String @default(cuid())`
- `Qualification.id`: `Int` ‚Üí `String @default(cuid())`
- `Responsibility.id`: `Int` ‚Üí `String @default(cuid())`
- `Benefit.id`: `Int` ‚Üí `String @default(cuid())`
- `Application.id`: `Int` ‚Üí `String @default(cuid())`
- `JobReport.id`: `Int` ‚Üí `String @default(cuid())`
- `StudentInterest.id`: `Int` ‚Üí `String @default(cuid())`
- `Resume.id`: `Int` ‚Üí `String @default(cuid())`

**All foreign keys updated:**
- `Student.degreeTypeId`: `Int` ‚Üí `String`
- `HR` relations
- `Job.hrId`: `Int` ‚Üí `String`
- `Application.jobId`, `studentId`, `resumeId`: `Int` ‚Üí `String`
- All nested relations (requirements, qualifications, etc.)

### Services Updated

#### `src/services/jobService.js`
- Removed all `Number()` conversions
- Updated JSDoc types from `@param {number}` to `@param {string}`
- Functions affected:
  - `getJobById(jobId)` - no longer casts to Number
  - `createJob(hrId, data)` - hrId is now string
  - `updateJob(jobId, hrId, data)` - both IDs are strings
  - `applyToJob(jobId, studentId, resumeLink)` - all IDs are strings
  - `manageApplication(jobId, hrId, applicationId, status)` - all IDs are strings
  - `getApplicants(jobId, hrId)` - all IDs are strings
  - `deleteJob(jobId, requester)` - jobId is string

#### `src/services/jobReportService.js`
- Updated all ID parameters to string type
- Removed `Number()` conversions
- Functions affected:
  - `isJobOwnedByHr(jobId, hrId)` - both IDs are strings
  - `createReport(userId, jobId, reason)` - jobId is string
  - `deleteReport(reportId)` - reportId is string

#### `src/services/profileService.js`
- Updated JSDoc for `degreeTypeId` from `number` to `string`

### Controllers
All controllers remain unchanged as they already pass IDs as-is from `req.params.id` (which are strings by default).

### Validators (`src/validators/jobValidator.js`)
- `manageApplicationSchema.applicationId`: Changed from `Joi.number().integer().positive()` to `Joi.string()`

### Seed File (`prisma/seed.js`)
- Added null check for `bachelor` degree type before using its ID
- All relations now use cuid() string IDs automatically generated by Prisma

## üß™ Testing

### Unit Tests
Update any hardcoded numeric IDs in test files:
```javascript
// Before
expect(job.id).toBe(1)

// After
expect(job.id).toMatch(/^c[a-z0-9]{24}$/) // cuid pattern
```

### Integration Tests
- Remove any `parseInt()` or `Number()` calls on IDs
- Update mock data to use string IDs
- Prisma will auto-generate cuid() IDs during test data creation

## ‚úÖ Verification Checklist

- [ ] Schema validates without errors (`npx prisma validate`)
- [ ] Migration created successfully
- [ ] Prisma client regenerated
- [ ] All services updated (no Number() conversions)
- [ ] All validators updated
- [ ] Seed script runs without errors
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] No TypeScript/JSDoc warnings

## üîÑ Rollback Plan

If issues occur:

1. **Restore database backup:**
   ```bash
   # SQLite
   cp prisma/dev.db.backup prisma/dev.db
   
   # PostgreSQL
   psql ku_connect < backup_YYYYMMDD.sql
   ```

2. **Revert schema changes:**
   ```bash
   git checkout HEAD -- prisma/schema.prisma
   npx prisma generate
   ```

3. **Revert code changes:**
   ```bash
   git checkout HEAD -- src/services/ src/validators/
   ```

## üìö Additional Notes

### Why cuid()?
- **Portable**: Works across distributed systems
- **Collision-resistant**: Virtually impossible to generate duplicates
- **Sortable**: Maintains chronological ordering
- **URL-safe**: No special characters
- **Consistent with User.id**: Already using cuid()

### Performance Considerations
- String comparison is marginally slower than integer comparison
- Index performance remains excellent for string primary keys
- No noticeable impact for typical workloads

### Future Considerations
- All new models should use `String @id @default(cuid())`
- Document this pattern in team guidelines
- Update API documentation to reflect string IDs

---

**Migration completed successfully! ‚ú®**
